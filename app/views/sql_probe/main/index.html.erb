<% if flash[:success] %>
  <div class="alert alert-info" role="alert">
    <%= flash[:success] %>
  </div>
<% end %>

<h1>Sql Probe</h1>

<div>
  <div class='pull-right'>
    <div class='col-xs-6'>
      <% if SqlProbe.listening? %>
        <%= button_to "Stop listening", stop_path, disabled: !SqlProbe.listening?, class: 'btn btn-lg btn-warning' %>
      <% else %>
        <%= button_to "Start listening", start_path, disabled: SqlProbe.listening?, class: 'btn btn-lg btn-success' %>
      <% end %>
    </div>

    <div class='col-xs-6'>
      <%= button_to "Clear queries", reset_path, class: 'btn btn-lg btn-danger' %>
    </div>
  </div>
</div>


<h2>Queries</h2>
<table class="table table-striped table-hover">
  <tr>
     <th>Controller</th>
     <th>Action</th>
     <th>Time</th>
     <% @tables.each do |name, count| %>
       <th><%= name %> (<%= count %>)</th>
     <% end %>
  </tr>

  <% @stats.each do |event| %>
  <tr>
    <td><%= event[:controller] %></td>
    <td><%= event[:action] %></td>
    <td><%= event[:file_ts] %></td>
    <% @tables.each do |name, _| %>
      <td>
        <%= event[:stats].reduce(0){ |acc, s|
          acc + s[:tables].select{|t| t == name}.size
         } %>
      </td>
    <% end %>
  </tr>
  <% end %>
</table>

<hr>

<h2>Raw Data</h2>
<pre><%= JSON.pretty_generate(@stats) %></pre>